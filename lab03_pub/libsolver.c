#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <sys/mman.h>
#include <dlfcn.h>
#include <sys/types.h>
#include <errno.h>
#include <unistd.h>
#include <signal.h>
#include "shuffle.h"

#define handle_error(msg)   \
    do                      \
    {                       \
        perror(msg);        \
        exit(EXIT_FAILURE); \
    } while (0)

long unsigned int (*new_func)(void) = NULL;
static int got_offset_map[] = {0, 101168, 98496, 101184, 98376, 101096, 99072, 101808, 0, 0, 97176, 0, 0, 0, 0, 99864, 0, 0, 0, 0, 97800, 0, 97808, 100552, 0, 100456, 97696, 100536, 97688, 0, 101240, 0, 0, 98520, 0, 0, 0, 0, 101112, 0, 0, 0, 0, 99216, 101976, 99176, 0, 99024, 101776, 0, 99824, 0, 0, 0, 0, 0, 99912, 97128, 99784, 0, 0, 98120, 100832, 0, 0, 0, 0, 98056, 0, 0, 98816, 101520, 0, 101472, 0, 101488, 98776, 101368, 0, 0, 0, 102312, 0, 0, 99528, 0, 0, 102184, 0, 0, 0, 0, 97504, 0, 0, 100144, 97368, 100112, 0, 0, 0, 100384, 97624, 0, 0, 0, 0, 0, 97432, 100184, 0, 100816, 98096, 100808, 98072, 100760, 0, 100720, 0, 0, 101664, 0, 0, 0, 101448, 0, 101408, 0, 0, 98736, 0, 0, 102256, 99496, 102224, 0, 0, 0, 0, 99560, 0, 97408, 100176, 0, 100160, 97528, 0, 97480, 0, 97552, 0, 0, 100784, 98064, 100744, 98040, 0, 98008, 100880, 98160, 98800, 0, 0, 101400, 98760, 0, 0, 101568, 0, 101536, 0, 102336, 0, 102320, 0, 96832, 99640, 0, 0, 102208, 97392, 0, 97520, 100248, 0, 100224, 97560, 0, 0, 100272, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100920, 97072, 99872, 0, 99848, 0, 0, 96912, 0, 96888, 0, 0, 0, 101872, 0, 0, 0, 0, 0, 101648, 0, 98440, 101136, 98400, 0, 98248, 0, 98232, 0, 0, 0, 97768, 0, 0, 0, 97616, 100352, 0, 0, 97584, 100424, 99840, 0, 99720, 0, 99704, 0, 0, 0, 99672, 96864, 0, 0, 0, 0, 98920, 0, 0, 101720, 0, 101680, 100976, 98224, 100960, 0, 0, 98312, 0, 0, 0, 98360, 0, 97632, 100368, 97608, 0, 0, 0, 0, 100416, 0, 96896, 0, 0, 99696, 96880, 99664, 96856, 99760, 0, 0, 101640, 99008, 0, 98984, 0, 0, 0, 0, 0, 98912, 97216, 0, 0, 0, 97240, 0, 0, 99856, 0, 0, 0, 97920, 0, 97912, 0, 97760, 0, 97752, 100520, 0, 98664, 101272, 0, 0, 0, 0, 98392, 0, 98384, 101088, 102080, 99376, 102056, 99344, 101848, 0, 0, 99112, 101840, 99104, 100032, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100640, 0, 0, 0, 100528, 0, 0, 0, 0, 101104, 0, 0, 0, 0, 0, 101160, 98456, 101128, 98432, 0, 0, 0, 0, 99096, 101904, 0, 101880, 0, 0, 97080, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 97744, 0, 0, 0, 0, 100512, 0, 0, 0, 0, 0, 0, 99584, 0, 0, 102296, 99320, 102048, 99304, 0, 101464, 98824, 101544, 0, 101504, 98624, 0, 98616, 0, 0, 98128, 0, 0, 100840, 0, 0, 97904, 0, 97872, 97496, 0, 97456, 100016, 0, 0, 0, 100000, 0, 99992, 99576, 0, 0, 102288, 0, 0, 99296, 0, 99288, 0, 101496, 98632, 0, 0, 0, 0, 0, 98568, 0, 0, 98112, 100848, 0, 0, 0, 0, 97880, 100632, 0, 100624, 100008, 0, 0, 97224, 0, 0, 0, 0, 0, 0, 102040, 0, 102032, 0, 0, 0, 0, 0, 0, 99440, 0, 0, 98608, 0, 0, 0, 0, 101256, 98688, 101288, 0, 99712, 96872, 0, 0, 99744, 0, 0, 102272, 99544, 0, 97600, 100360, 97648, 0, 0, 0, 0, 100208, 97440, 100968, 0, 0, 98288, 0, 0, 0, 98088, 100792, 98080, 0, 101688, 98992, 101656, 98944, 0, 0, 101440, 98784, 101416, 0, 96904, 0, 102280, 0, 102264, 99520, 0, 99504, 0, 97640, 100392, 0, 0, 0, 0, 97448, 100200, 97424, 0, 0, 100824, 98104, 100800, 0, 0, 98048, 100728, 98016, 100904, 0, 98952, 101480, 98808, 101456, 98792, 101424, 98768, 0, 0, 0, 99512, 0, 99488, 102232, 0, 0, 0, 0, 0, 100192, 97416, 0, 0, 0, 0, 0, 97472, 100216, 0, 0, 99552, 0, 0, 0, 0, 96816, 99624, 0, 100312, 0, 0, 0, 101584, 0, 0, 0, 0, 0, 0, 98168, 100864, 0, 0, 98200, 0, 0, 0, 98864, 101608, 100240, 97536, 100264, 0, 100280, 98192, 100936, 98176, 0, 98144, 0, 96824, 99616, 0, 0, 0, 100288, 0, 100256, 0, 101576, 98848, 0, 0, 0, 0, 0, 99632, 0, 99600, 100912, 98896, 101624, 98872, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 98184, 0, 98152, 100872, 0, 0, 97592, 0, 0, 100320, 97576, 100328, 0, 99568, 102344, 0, 0, 0, 99656, 0, 0, 0, 0, 101552, 98840, 101600, 0, 99752, 0, 0, 96952, 0, 96992, 100472, 0, 100440, 100400, 97664, 100432, 0, 0, 0, 101032, 98352, 101016, 98328, 98272, 0, 0, 0, 0, 0, 99064, 0, 99040, 101704, 0, 0, 0, 0, 0, 0, 0, 0, 96984, 99728, 0, 96960, 0, 0, 100464, 0, 0, 0, 100408, 0, 0, 101040, 0, 101024, 98320, 0, 98304, 100984, 98264, 0, 101056, 98344, 101768, 0, 101744, 0, 101696, 0, 0, 98960, 0, 97056, 99800, 0, 0, 97024, 98968, 101672, 0, 101712, 0, 0, 97704, 100504, 0, 99736, 96920, 99768, 96944, 0, 0, 0, 0, 0, 101072, 0, 101080, 98368, 0, 97656, 101888, 99120, 0, 0, 0, 99192, 0, 99944, 97120, 0, 0, 101192, 0, 0, 98488, 0, 99232, 101920, 0, 0, 0, 0, 100568, 98512, 0, 98472, 0, 98448, 101152, 98408, 0, 0, 0, 0, 97792, 0, 0, 0, 0, 0, 0, 97152, 99952, 0, 0, 0, 0, 97104, 0, 97016, 101208, 98480, 101936, 99224, 101928, 99208, 101896, 99152, 0, 0, 98592, 0, 98544, 0, 98552, 101248, 97776, 0, 0, 0, 100616, 97824, 100592, 97832, 0, 0, 99880, 97112, 0, 0, 0, 0, 0, 0, 97192, 99960, 0, 0, 0, 0, 0, 102024, 99264, 101992, 99240, 0, 99248, 101120, 98416, 0, 102072, 99392, 102096, 99416, 0, 0, 97352, 0, 97344, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 100648, 100664, 97944, 0, 0, 101336, 98712, 0, 98704, 0, 98680, 101312, 0, 102168, 99408, 0, 0, 102120, 0, 0, 0, 0, 0, 0, 97360, 100096, 97336, 100072, 97296, 0, 97248, 100752, 0, 100704, 97984, 100712, 0, 100064, 0, 0, 0, 98744, 101344, 0, 101352, 0, 0, 0, 0, 0, 100680, 99472, 102216, 0, 0, 99464, 0, 0, 102192, 0, 0, 0, 100168, 0, 100136, 0, 100152, 97376, 0, 102064, 99384, 98000, 0, 0, 100080, 0, 100104, 0, 0, 0, 100696, 0, 99808, 0, 0, 97032, 0, 0, 99792, 96936, 0, 0, 97728, 100496, 97736, 0, 97720, 100480, 0, 0, 97672, 0, 101008, 0, 101048, 0, 0, 98280, 100992, 0, 0, 0, 0, 101736, 0, 101760, 99048, 0, 0, 0, 0, 99688, 0, 0, 0, 0, 96968, 0, 0, 0, 97968, 0, 100344, 0, 0, 0, 101296, 98640, 0, 0, 101320, 0, 0, 0, 98336, 101064, 0, 0, 98296, 102112, 99336, 0, 101752, 99032, 101792, 98976, 0, 0, 0, 0, 0, 0, 0, 97816, 0, 97888, 100608, 0, 0, 0, 0, 100304, 0, 0, 98528, 0, 98600, 0, 98584, 101376, 98696, 0, 99280, 0, 99256, 0, 99200, 101960, 99136, 0, 0, 98752, 101392, 0, 0, 98424, 101144, 99592, 102304, 0, 0, 100736, 98032, 0, 0, 0, 98856, 101512, 0, 101616, 98888, 0, 0, 97136, 99928, 97144, 0, 97096, 99904, 0, 0, 99536, 0, 99184, 101944, 99128, 0, 0, 97512, 100232, 97488, 0, 99816, 97008, 0, 0, 0, 97048, 0, 0, 0, 97992, 0, 0, 101800, 0, 101832, 99080, 101816, 0, 101592, 0, 0, 0, 0, 0, 98136, 100944, 0, 0, 98216, 102240, 0, 102176, 0, 97712, 100488, 97464, 0, 97544, 100296, 0, 97064, 99832, 97040, 99888, 0, 0, 0, 99968, 0, 102248, 0, 102200, 99432, 102152, 0, 102088, 0, 102128, 0, 0, 97400, 100088, 97384, 0, 97320, 0, 97264, 100048, 97304, 0, 97864, 0, 0, 0, 97936, 101728, 0, 0, 99056, 98576, 101264, 98536, 0, 98672, 96976, 0, 96928, 0, 97000, 0, 0, 99424, 102144, 0, 0, 99352, 102104, 0, 0, 97232, 100120, 0, 100128, 97256, 100040, 97288, 0, 98256, 101000, 97840, 0, 0, 101632, 98936, 0, 98928, 0, 99016, 101824, 0, 0, 96840, 99648, 0, 0, 96848, 0, 0, 99776, 101984, 0, 102008, 100336, 97568, 100376, 0, 100448, 0, 0, 0, 97184, 0, 97200, 0, 0, 0, 0, 0, 0, 98880, 0, 0, 0, 98904, 0, 98832, 0, 99920, 97088, 100952, 0, 100928, 98208, 0, 0, 100888, 99168, 101856, 0, 0, 98464, 0, 0, 101224, 0, 101200, 0, 0, 0, 0, 99608, 97784, 100544, 0, 100584, 0, 100560, 97856, 0, 0, 0, 101560, 0, 0, 99896, 97168, 99936, 97160, 0, 0, 100856, 0, 100896, 99160, 101864, 99144, 0, 0, 101952, 98504, 101216, 98560, 101176, 0, 101232, 0, 0, 98656, 0, 100576, 0, 0, 97896, 100600, 0, 0, 97928, 0, 97848, 99984, 0, 0, 0, 0, 97208, 100056, 0, 99976, 0, 101912, 99272, 0, 0, 102016, 99368, 102000, 0, 101968, 99312, 99088, 101784, 0, 0, 0, 0, 99000, 97312, 0, 97280, 0, 0, 0, 100656, 97976, 100688, 0, 0, 97952, 100776, 0, 97680, 101304, 98648, 101280, 0, 101328, 0, 0, 0, 0, 0, 0, 102136, 99328, 0, 99448, 102160, 0, 0, 0, 0, 0, 0, 0, 100024, 97272, 0, 97328, 0, 100672, 97960, 0, 0, 100768, 0, 0, 98024, 0, 0, 0, 101384, 0, 101432, 98720, 0, 0, 101528, 98728, 101360, 0, 99400, 0, 99456, 0, 99480, 102328};
// static int got_offset_map[] = {0, 154392, 151712, 154408, 151592, 154320, 152288, 155040, 0, 0, 150392, 0, 0, 0, 0, 153088, 0, 0, 0, 0, 151024, 0, 151032, 153776, 0, 153680, 150920, 153760, 150912, 0, 154464, 0, 0, 151736, 0, 0, 0, 0, 154336, 0, 0, 0, 0, 152432, 155208, 152392, 0, 152240, 155000, 0, 153048, 0, 0, 0, 0, 0, 153136, 150344, 153008, 0, 0, 151344, 154056, 0, 0, 0, 0, 151280, 0, 0, 152032, 154744, 0, 154696, 0, 154712, 151992, 154592, 0, 0, 0, 155552, 0, 0, 152744, 0, 0, 155416, 0, 0, 0, 0, 150720, 0, 0, 153368, 150584, 153336, 0, 0, 0, 153608, 150848, 0, 0, 0, 0, 0, 150648, 153408, 0, 154040, 151320, 154032, 151296, 153984, 0, 153944, 0, 0, 154888, 0, 0, 0, 154672, 0, 154632, 0, 0, 151952, 0, 0, 155496, 152712, 155464, 0, 0, 0, 0, 152784, 0, 150624, 153400, 0, 153384, 150744, 0, 150696, 0, 150768, 0, 0, 154008, 151288, 153968, 151264, 0, 151232, 154104, 151384, 152016, 0, 0, 154624, 151976, 0, 0, 154792, 0, 154760, 0, 155576, 0, 155560, 0, 150040, 152864, 0, 0, 155448, 150608, 0, 150736, 153472, 0, 153448, 150776, 0, 0, 153496, 0, 0, 0, 0, 0, 0, 0, 0, 0, 154144, 150280, 153096, 0, 153072, 0, 0, 150120, 0, 150096, 0, 0, 0, 155104, 0, 0, 0, 0, 0, 154872, 0, 151656, 154360, 151616, 0, 151464, 0, 151456, 0, 0, 0, 150992, 0, 0, 0, 150840, 153576, 0, 0, 150800, 153648, 153064, 0, 152944, 0, 152928, 0, 0, 0, 152896, 150072, 0, 0, 0, 0, 152136, 0, 0, 154944, 0, 154904, 154200, 151448, 154184, 0, 0, 151528, 0, 0, 0, 151576, 0, 150856, 153592, 150832, 0, 0, 0, 0, 153640, 0, 150104, 0, 0, 152920, 150088, 152888, 150064, 152984, 0, 0, 154864, 152224, 0, 152200, 0, 0, 0, 0, 0, 152128, 150432, 0, 0, 0, 150456, 0, 0, 153080, 0, 0, 0, 151144, 0, 151136, 0, 150984, 0, 150976, 153744, 0, 151880, 154496, 0, 0, 0, 0, 151608, 0, 151600, 154312, 155312, 152584, 155288, 152560, 155080, 0, 0, 152328, 155072, 152320, 153256, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 153864, 0, 0, 0, 153752, 0, 0, 0, 0, 154328, 0, 0, 0, 0, 0, 154384, 151672, 154352, 151648, 0, 0, 0, 0, 152312, 155136, 0, 155112, 0, 0, 150288, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 150968, 0, 0, 0, 0, 153736, 0, 0, 0, 0, 0, 0, 152808, 0, 0, 155536, 152536, 155280, 152520, 0, 154688, 152040, 154768, 0, 154728, 151840, 0, 151832, 0, 0, 151352, 0, 0, 154064, 0, 0, 151128, 0, 151096, 150712, 0, 150672, 153240, 0, 0, 0, 153224, 0, 153216, 152800, 0, 0, 155528, 0, 0, 152512, 0, 152504, 0, 154720, 151848, 0, 0, 0, 0, 0, 151784, 0, 0, 151336, 154072, 0, 0, 0, 0, 151104, 153856, 0, 153848, 153232, 0, 0, 150440, 0, 0, 0, 0, 0, 0, 155272, 0, 155264, 0, 0, 0, 0, 0, 0, 152648, 0, 0, 151824, 0, 0, 0, 0, 154480, 151904, 154512, 0, 152936, 150080, 0, 0, 152968, 0, 0, 155512, 152760, 0, 150824, 153584, 150872, 0, 0, 0, 0, 153432, 150656, 154192, 0, 0, 151504, 0, 0, 0, 151312, 154016, 151304, 0, 154912, 152208, 154880, 152160, 0, 0, 154664, 152000, 154640, 0, 150112, 0, 155520, 0, 155504, 152736, 0, 152720, 0, 150864, 153616, 0, 0, 0, 0, 150664, 153424, 150640, 0, 0, 154048, 151328, 154024, 0, 0, 151272, 153952, 151240, 154128, 0, 152168, 154704, 152024, 154680, 152008, 154648, 151984, 0, 0, 0, 152728, 0, 152704, 155472, 0, 0, 0, 0, 0, 153416, 150632, 0, 0, 0, 0, 0, 150688, 153440, 0, 0, 152768, 0, 0, 0, 0, 150024, 152848, 0, 153536, 0, 0, 0, 154808, 0, 0, 0, 0, 0, 0, 151392, 154088, 0, 0, 151424, 0, 0, 0, 152080, 154832, 153464, 150752, 153488, 0, 153504, 151416, 154160, 151400, 0, 151368, 0, 150032, 152840, 0, 0, 0, 153512, 0, 153480, 0, 154800, 152064, 0, 0, 0, 0, 0, 152856, 0, 152824, 154136, 152112, 154848, 152088, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 151408, 0, 151376, 154096, 0, 0, 150816, 0, 0, 153544, 150792, 153552, 0, 152792, 155584, 0, 0, 0, 152880, 0, 0, 0, 0, 154776, 152056, 154824, 0, 152976, 0, 0, 150160, 0, 150200, 153696, 0, 153664, 153624, 150888, 153656, 0, 0, 0, 154256, 151568, 154240, 151544, 151488, 0, 0, 0, 0, 0, 152280, 0, 152256, 154928, 0, 0, 0, 0, 0, 0, 0, 0, 150192, 152952, 0, 150168, 0, 0, 153688, 0, 0, 0, 153632, 0, 0, 154264, 0, 154248, 151536, 0, 151520, 154208, 151480, 0, 154280, 151560, 154992, 0, 154968, 0, 154920, 0, 0, 152176, 0, 150264, 153024, 0, 0, 150232, 152184, 154896, 0, 154936, 0, 0, 150928, 153728, 0, 152960, 150128, 152992, 150152, 0, 0, 0, 0, 0, 154296, 0, 154304, 151584, 0, 150880, 155120, 152336, 0, 0, 0, 152408, 0, 153168, 150336, 0, 0, 154416, 0, 0, 151704, 0, 152448, 155152, 0, 0, 0, 0, 153792, 151728, 0, 151688, 0, 151664, 154376, 151624, 0, 0, 0, 0, 151016, 0, 0, 0, 0, 0, 0, 150368, 153176, 0, 0, 0, 0, 150312, 0, 150224, 154432, 151696, 155168, 152440, 155160, 152424, 155128, 152368, 0, 0, 151808, 0, 151760, 0, 151768, 154472, 151000, 0, 0, 0, 153840, 151048, 153816, 151056, 0, 0, 153104, 150328, 0, 0, 0, 0, 0, 0, 150408, 153184, 0, 0, 0, 0, 0, 155256, 152480, 155224, 152456, 0, 152464, 154344, 151632, 0, 155304, 152600, 155328, 152624, 0, 0, 150568, 0, 150560, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 153872, 153888, 151168, 0, 0, 154560, 151928, 0, 151920, 0, 151896, 154536, 0, 155400, 152616, 0, 0, 155352, 0, 0, 0, 0, 0, 0, 150576, 153320, 150552, 153296, 150512, 0, 150464, 153976, 0, 153928, 151208, 153936, 0, 153288, 0, 0, 0, 151960, 154568, 0, 154576, 0, 0, 0, 0, 0, 153904, 152688, 155456, 0, 0, 152680, 0, 0, 155432, 0, 0, 0, 153392, 0, 153360, 0, 153376, 150592, 0, 155296, 152592, 151224, 0, 0, 153304, 0, 153328, 0, 0, 0, 153920, 0, 153032, 0, 0, 150240, 0, 0, 153016, 150144, 0, 0, 150952, 153720, 150960, 0, 150944, 153704, 0, 0, 150896, 0, 154232, 0, 154272, 0, 0, 151496, 154216, 0, 0, 0, 0, 154960, 0, 154984, 152264, 0, 0, 0, 0, 152912, 0, 0, 0, 0, 150176, 0, 0, 0, 151192, 0, 153568, 0, 0, 0, 154520, 151856, 0, 0, 154544, 0, 0, 0, 151552, 154288, 0, 0, 151512, 155344, 152552, 0, 154976, 152248, 155016, 152192, 0, 0, 0, 0, 0, 0, 0, 151040, 0, 151112, 153832, 0, 0, 0, 0, 153528, 0, 0, 151744, 0, 151816, 0, 151800, 154600, 151912, 0, 152496, 0, 152472, 0, 152416, 155192, 152352, 0, 0, 151968, 154616, 0, 0, 151640, 154368, 152816, 155544, 0, 0, 153960, 151256, 0, 0, 0, 152072, 154736, 0, 154840, 152104, 0, 0, 150352, 153152, 150360, 0, 150304, 153128, 0, 0, 152752, 0, 152400, 155176, 152344, 0, 0, 150728, 153456, 150704, 0, 153040, 150216, 0, 0, 0, 150256, 0, 0, 0, 151216, 0, 0, 155024, 0, 155064, 152296, 155048, 0, 154816, 0, 0, 0, 0, 0, 151360, 154168, 0, 0, 151440, 155480, 0, 155408, 0, 150936, 153712, 150680, 0, 150760, 153520, 0, 150272, 153056, 150248, 153112, 0, 0, 0, 153192, 0, 155488, 0, 155440, 152640, 155384, 0, 155320, 0, 155360, 0, 0, 150616, 153312, 150600, 0, 150536, 0, 150480, 153272, 150520, 0, 151088, 0, 0, 0, 151160, 154952, 0, 0, 152272, 151792, 154488, 151752, 0, 151888, 150184, 0, 150136, 0, 150208, 0, 0, 152632, 155376, 0, 0, 152568, 155336, 0, 0, 150448, 153344, 0, 153352, 150472, 153264, 150504, 0, 151472, 154224, 151064, 0, 0, 154856, 152152, 0, 152144, 0, 152232, 155056, 0, 0, 150048, 152872, 0, 0, 150056, 0, 0, 153000, 155216, 0, 155240, 153560, 150784, 153600, 0, 153672, 0, 0, 0, 150400, 0, 150416, 0, 0, 0, 0, 0, 0, 152096, 0, 0, 0, 152120, 0, 152048, 0, 153144, 150296, 154176, 0, 154152, 151432, 0, 0, 154112, 152384, 155088, 0, 0, 151680, 0, 0, 154448, 0, 154424, 0, 0, 0, 0, 152832, 151008, 153768, 0, 153808, 0, 153784, 151080, 0, 0, 0, 154784, 0, 0, 153120, 150384, 153160, 150376, 0, 0, 154080, 0, 154120, 152376, 155096, 152360, 0, 0, 155184, 151720, 154440, 151776, 154400, 0, 154456, 0, 0, 151872, 0, 153800, 0, 0, 151120, 153824, 0, 0, 151152, 0, 151072, 153208, 0, 0, 0, 0, 150424, 153280, 0, 153200, 0, 155144, 152488, 0, 0, 155248, 152576, 155232, 0, 155200, 152528, 152304, 155008, 0, 0, 0, 0, 152216, 150528, 0, 150496, 0, 0, 0, 153880, 151200, 153912, 0, 0, 151176, 154000, 0, 150904, 154528, 151864, 154504, 0, 154552, 0, 0, 0, 0, 0, 0, 155368, 152544, 0, 152656, 155392, 0, 0, 0, 0, 0, 0, 0, 153248, 150488, 0, 150544, 0, 153896, 151184, 0, 0, 153992, 0, 0, 151248, 0, 0, 0, 154608, 0, 154656, 151936, 0, 0, 154752, 151944, 154584, 0, 152608, 0, 152672, 0, 152696, 155568};
int init()
{
    // get runtime program's memory address
    FILE *fp = fopen("/proc/self/maps", "r");

    char *line = NULL;
    size_t len = 0;
    ssize_t read;

    if (fp == NULL)
        return 1;

    read = getline(&line, &len, fp);
    fprintf(stdout, "%s", line);
    // printf("-------");

    char base_address[20];
    strncpy(base_address, line, 12);    //first 12 char is the base addresss of HEX in 64 bits computer

    while ((read = getline(&line, &len, fp)) != -1)
    {
        fprintf(stdout, "%s", line);
    }
    fclose(fp);

    long unsigned int base_address_long = (long unsigned int)strtol(base_address, NULL, 16);
    printf("base_address = %lx\n", base_address_long);

    int pagesize = sysconf(_SC_PAGE_SIZE);
    if (pagesize == -1)
        handle_error("sysconf");

    printf("pagesize : %x\n", pagesize);

    printf("base_address + pagesize * 26 = %lx\n", base_address_long + pagesize * 26);
    long unsigned int *b_addr = (long unsigned int *)base_address_long;
    if (mprotect(b_addr, pagesize * 26, PROT_READ | PROT_WRITE | PROT_EXEC) == -1)
    {
        printf("%d\n", errno);
        handle_error("mprotect");
    }
    // printf("base_address + 15000(hex) + pagesize * 15 = %lx\n", base_address_long + 86016 + pagesize * 15);
    // long unsigned int *b_addr = (long unsigned int *)(base_address_long+pagesize * 15);
    // if (mprotect(b_addr, pagesize * 15, PROT_READ | PROT_WRITE | PROT_EXEC) == -1)
    // {
    //     printf("%d\n", errno);
    //     handle_error("mprotect");
    // }
    

    void *handle = dlopen("libpoem.so", RTLD_LAZY);
    if (handle != NULL)
    {
        char func[20];
        long unsigned int func_address_long;

        for (int i = 0; i < 1477; i++)
        {
            // check if code_i is called in chals by checking GOT
            if (got_offset_map[ndat[i]] != 0)
            {
                printf("remapping code_%d to code_%d\n", ndat[i], i);
                sprintf(func, "code_%d", i);
                new_func = dlsym(handle, func);

                // write new_func to code_i's GOT entry value -> pos = got_offset_map[i]
                func_address_long = base_address_long + got_offset_map[ndat[i]];
                long unsigned int *f_addr = (long unsigned int *)func_address_long;
                // printf("i : %d -----f_addr : %lx\n", i, f_addr);
                *f_addr = (long unsigned int)new_func;
                // *f_addr = new_func;
            }
        }
    }

    if (mprotect(b_addr, pagesize * 11, PROT_READ) == -1)
    {
        printf("%d\n", errno);
        handle_error("mprotect");
    }
    b_addr = (long unsigned int *)(base_address_long + pagesize * 11); // b + p11
    if (mprotect(b_addr, pagesize * 11, PROT_READ | PROT_EXEC) == -1)
    {
        printf("%d\n", errno);
        handle_error("mprotect");
    }
    b_addr = (long unsigned int *)(base_address_long + pagesize * 22); // b + p22
    if (mprotect(b_addr, pagesize * 3, PROT_READ) == -1)
    {
        printf("%d\n", errno);
        handle_error("mprotect");
    }
    b_addr = (long unsigned int *)(base_address_long + pagesize * 25); // b + p22
    if (mprotect(b_addr, pagesize * 1, PROT_READ | PROT_WRITE) == -1)
    {
        printf("%d\n", errno);
        handle_error("mprotect");
    }

    printf("Finish GOT remapping\n");

    return 0;
}
